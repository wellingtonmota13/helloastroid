{"version":3,"sources":["../../../src/schema/types/type-file.js"],"names":["setFileNodeRootType","shouldInfer","getType","getListType","require","GraphQLList","_","mime","isRelative","isRelativeUrl","normalize","systemPath","getNode","getNodes","getRootNodeId","createPageDependency","joinPath","type","listType","fileNodeRootType","createType","findRootNode","node","rootNode","whileCount","rootNodeId","parent","undefined","console","log","pointsToFile","nodes","key","value","looksLikeFile","isString","lookup","find","get","n","visit","current","selector","fn","i","keys","Object","length","concat","proceed","isNormalInteger","test","str","isMatch","v","k","normalizedSelector","map","s","filter","fullSelector","join","internal","pathToOtherNode","dir","otherFileExists","some","absolutePath","isEmpty","isArray","resolve","args","path","fieldName","fieldValue","findLinkedFileNode","fileLinkPath","parentFileNode","relativePath","linkedFileNode","nodeId","id"],"mappings":"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","file":"type-file.js","sourcesContent":["const { GraphQLList } = require(`graphql`)\nconst _ = require(`lodash`)\nconst mime = require(`mime`)\nconst isRelative = require(`is-relative`)\nconst isRelativeUrl = require(`is-relative-url`)\nconst normalize = require(`normalize-path`)\nconst systemPath = require(`path`)\n\nconst { getNode, getNodes, getRootNodeId } = require(`../../redux`)\nconst {\n  createPageDependency,\n} = require(`../../redux/actions/add-page-dependency`)\nconst { joinPath } = require(`../../utils/path`)\n\nlet type, listType\n\nexport function setFileNodeRootType(fileNodeRootType) {\n  if (fileNodeRootType) {\n    type = createType(fileNodeRootType, false)\n    listType = createType(fileNodeRootType, true)\n  } else {\n    type = null\n    listType = null\n  }\n}\n\nfunction findRootNode(node) {\n  // Find the root node.\n  let rootNode = node\n  let whileCount = 0\n  let rootNodeId\n  while (\n    (rootNodeId = getRootNodeId(rootNode) || rootNode.parent) &&\n    (getNode(rootNode.parent) !== undefined || getNode(rootNodeId)) &&\n    whileCount < 101\n  ) {\n    if (rootNodeId) {\n      rootNode = getNode(rootNodeId)\n    } else {\n      rootNode = getNode(rootNode.parent)\n    }\n    whileCount += 1\n    if (whileCount > 100) {\n      console.log(\n        `It looks like you have a node that's set its parent as itself`,\n        rootNode\n      )\n    }\n  }\n\n  return rootNode\n}\n\nfunction pointsToFile(nodes, key, value) {\n  const looksLikeFile =\n    _.isString(value) &&\n    mime.lookup(value) !== `application/octet-stream` &&\n    // domains ending with .com\n    mime.lookup(value) !== `application/x-msdownload` &&\n    isRelative(value) &&\n    isRelativeUrl(value)\n\n  if (!looksLikeFile) {\n    return false\n  }\n\n  // Find the node used for this example.\n  let node = nodes.find(n => _.get(n, key) === value)\n\n  if (!node) {\n    // Try another search as our \"key\" isn't always correct e.g.\n    // it doesn't support arrays so the right key could be \"a.b[0].c\" but\n    // this function will get \"a.b.c\".\n    //\n    // We loop through every value of nodes until we find\n    // a match.\n    const visit = (current, selector = [], fn) => {\n      for (let i = 0, keys = Object.keys(current); i < keys.length; i++) {\n        const key = keys[i]\n        const value = current[key]\n\n        if (value === undefined || value === null) continue\n\n        if (typeof value === `object` || typeof value === `function`) {\n          visit(current[key], selector.concat([key]), fn)\n          continue\n        }\n\n        let proceed = fn(current[key], key, selector, current)\n\n        if (proceed === false) {\n          break\n        }\n      }\n    }\n\n    const isNormalInteger = str => /^\\+?(0|[1-9]\\d*)$/.test(str)\n\n    node = nodes.find(n => {\n      let isMatch = false\n      visit(n, [], (v, k, selector, parent) => {\n        if (v === value) {\n          // Remove integers as they're for arrays, which our passed\n          // in object path doesn't have.\n          const normalizedSelector = selector\n            .map(s => (isNormalInteger(s) ? `` : s))\n            .filter(s => s !== ``)\n          const fullSelector = `${normalizedSelector.join(`.`)}.${k}`\n          if (fullSelector === key) {\n            isMatch = true\n            return false\n          }\n        }\n\n        // Not a match so we continue\n        return true\n      })\n\n      return isMatch\n    })\n\n    // Still no node.\n    if (!node) {\n      return false\n    }\n  }\n\n  const rootNode = findRootNode(node)\n\n  // Only nodes transformed (ultimately) from a File\n  // can link to another File.\n  if (rootNode.internal.type !== `File`) {\n    return false\n  }\n\n  const pathToOtherNode = normalize(joinPath(rootNode.dir, value))\n  const otherFileExists = getNodes().some(\n    n => n.absolutePath === pathToOtherNode\n  )\n  return otherFileExists\n}\n\nexport function shouldInfer(nodes, selector, value) {\n  return (\n    nodes[0].internal.type !== `File` &&\n    ((_.isString(value) &&\n      !_.isEmpty(value) &&\n      pointsToFile(nodes, selector, value)) ||\n      (_.isArray(value) &&\n        _.isString(value[0]) &&\n        !_.isEmpty(value[0]) &&\n        pointsToFile(nodes, `${selector}[0]`, value[0])))\n  )\n}\n\nfunction createType(fileNodeRootType, isArray) {\n  if (!fileNodeRootType) return null\n\n  return {\n    type: isArray ? new GraphQLList(fileNodeRootType) : fileNodeRootType,\n    resolve: (node, args, { path }, { fieldName }) => {\n      let fieldValue = node[fieldName]\n\n      if (!fieldValue) {\n        return null\n      }\n\n      const findLinkedFileNode = relativePath => {\n        // Use the parent File node to create the absolute path to\n        // the linked file.\n        const fileLinkPath = normalize(\n          systemPath.resolve(parentFileNode.dir, relativePath)\n        )\n\n        // Use that path to find the linked File node.\n        const linkedFileNode = _.find(\n          getNodes(),\n          n => n.internal.type === `File` && n.absolutePath === fileLinkPath\n        )\n        if (linkedFileNode) {\n          createPageDependency({\n            path,\n            nodeId: linkedFileNode.id,\n          })\n          return linkedFileNode\n        } else {\n          return null\n        }\n      }\n\n      // Find the File node for this node (we assume the node is something\n      // like markdown which would be a child node of a File node).\n      const parentFileNode = findRootNode(node)\n\n      // Find the linked File node(s)\n      if (isArray) {\n        return fieldValue.map(relativePath => findLinkedFileNode(relativePath))\n      } else {\n        return findLinkedFileNode(fieldValue)\n      }\n    },\n  }\n}\n\nexport function getType() {\n  return type\n}\n\nexport function getListType() {\n  return listType\n}\n"]}